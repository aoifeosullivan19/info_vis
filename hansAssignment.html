<!DOCTYPE html>
<html lang = "en" class="tas-com">
<head>
	<meta charset="utf-8">
	<title>D3 Assignment</title>
	<link href="./themes/prism.css" rel="stylesheet" />
	<link href="./themes/tas_style.css" rel="stylesheet" />
	<script type="text/javascript" src="./d3/d3.v4.js" charset="utf-8"></script>
	<script src="./lib/prism.js" charset="utf-8"></script>
	<style type="text/css">
		.axis path,
		.axis line {
		    fill: none;
		    stroke: black;
		    shape-rendering: crispEdges;
		}
		
		.axis text {
		    font-family: sans-serif;
		    font-size: 11px;
		}	
        
        div.tooltip {	
    position: absolute;			
    text-align: center;			
    width: 60px;					
    height: 20px;					
    padding: 1px;				
    font: 12px sans-serif;		
    border: 1px;		
    border-radius: 1px;	
    pointer-events: none;			
}
        
        /* http://bl.ocks.org/d3noob/a22c42db65eb00d4e369 */
	</style>
</head>
<body>

	<h1>Channelling Hans</h1>
    	
		<h3 id = "year_header">Year: </h3>
	
	<div class = "demo">
        <div class = "button-bar">
			<div class = "play_button">Play All</div>
		</div>
		<hr style="clear:both;">
		<div class = "button-bar">
			<div class = "button selected">2007</div> <div class = "button">2008</div> <div class = "button">2009</div>
		</div>
		<hr style="clear:both;">
		<div>
            
            
	<div class="slidecontainer">
<button type="button" id="play">play</button>
	<button type="button" id="pause">pause</button>
  <input type="range" min="2007" max="2017" value="1" class="slider" id="myRange">
          <p>Value: <span id="demo"></span></p>
</div>
            
		<script type="text/javascript" id = "demo_code">


// Define margins
var margin = {top: 20, right: 20, bottom: 55, left: 90};

//Width and height
var outer_width = 700;
var outer_height = 500;
var svg_width = outer_width - margin.left - margin.right;
var svg_height = outer_height - margin.top - margin.bottom;

//Define a date parser
var formatDate = d3.timeParse("%y");

// The global data set object
var dataset;


// Set up the scale to be used on the x axis
xScale = d3.scaleLinear()
				.range([20, svg_width]);
        

// Set up the scale to be used on the y axis
yScale = d3.scaleLinear()
				.range([svg_height, 0]);
            
rScale=d3.scaleSqrt()
               .range([1, 20]);
            
var circleColor=d3.scaleOrdinal(d3.schemeCategory20);

			
// Create an x-axis connected to the x scale
var xAxis = d3.axisBottom()
			  	.scale(xScale)
				.ticks(10);

//Define Y axis
var yAxis = d3.axisLeft()
				  .scale(yScale)
				  .ticks(10);
							  

var div = d3.select("body").append("div")	
    .attr("class", "tooltip")				
    .style("opacity", 0);
            

//Create SVG element as a group with the margins transform applied to it
var svg = d3.select("body")
			.append("svg")
			.attr("width", svg_width + margin.left + margin.right)
			.attr("height", svg_height + margin.top + margin.bottom)
			.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			

display_year=2007;

// define a function that filters data by year
function yearFilter(value){
	return (value.Year == display_year)
}

            

function generateVis(){


    
    	// Filter the data to only include the current year
	var filtered_dataset = dataset.filter(yearFilter);
 console.log(filtered_dataset);

//	// Update the axis domains based on the loaded data
	xScale.domain([0, d3.max(dataset, function(d) { return +d.GDP;}) ])
	yScale.domain([0, d3.max(dataset, function(d) { return +d.Global_Competitiveness_Index; })]);


	// Call the axes objects
	svg.select("#x-axis").call(xAxis);
	svg.select("#y-axis").call(yAxis);
    
    	/******** PERFORM DATA JOIN ************/
	  	// Join new data with old elements, if any.
		var points = svg.selectAll("circle")
							.data(filtered_dataset);

    
   
    
		/******** HANDLE UPDATE SELECTION ************/
	  	// Update the display of existing elelemnts to mathc new data
	  	// Perform a data join and add points to the chart

 
        points
        .transition()
    .duration(300)
//      .ease(d3.easeBack)
            .attr("cx",function(d){
									return xScale(d.GDP);
								})
    		.attr("cy", function(d){
									return yScale(d.Global_Competitiveness_Index);
								})
            .attr("r", function(d){
                                    return rScale(d.Population);
     
        })
		   	.style("fill", function (d) {
                                    return circleColor(d.Country)
                       })
//      .on("mouseover", function(d) {		
//            div.transition()		
//                .duration(100)		
//                .style("opacity", .99);		
//            div	.html(d.Country)	
//                .style("left", (d3.event.pageX) + "px")		
//                .style("top", (d3.event.pageY + 5) + "px");	
//            })	
    ;


		/******** HANDLE ENTER SELECTION ************/
	  	// Create new elements in the dataset
	  	// Perform a data join and add points to the chart
    
 
		points.enter()
			.append("circle")
                .transition()
                .duration(2000)
          .ease(d3.easeBounce)
				.attr("cx", function(d){
									return xScale(d.GDP);
								})
				.attr("cy", function(d){
									return yScale(d.Global_Competitiveness_Index);
								})
				.attr("r", function(d){
                                    return rScale(d.Population);
     
        })
				.style("fill", function (d) {
                                    return circleColor(d.Country)
                       })

//                 .on("mouseover", function(d) {		
//            div.transition()		
//                .duration(100)		
//                .style("opacity", .99);		
//            div	.html(d.Country)	
//                .style("left", (d3.event.pageX) + "px")		
//                .style("top", (d3.event.pageY + 5) + "px");	
   //         })			// http://bl.ocks.org/d3noob/a22c42db65eb00d4e369 //		
    ;


    
    
		/******** HANDLE EXIT SELECTION ************/
		// Remove elements that not longer have a matching data eleement
		points.exit()
    
            .remove();
    	
    
	// Set the year label
	d3.select("#year_header").text("Year: " + display_year)
}

// Load the file data.csv and generate a visualisation based on it
	d3.csv("./data/test.csv", function(error, data){
		
		// handle any data loading errors
		if(error){
			console.log("Something went wrong");
			console.log(error);
		}else{
			console.log("Data Loaded");
      
	// Assign  the data object loaded to the global dataset variable
			dataset = data;
            generateVis();
			// convert each variable to numeric type and parse the date
            
                   // Add an on-click event handler to each button that updates the display year
d3.selectAll(".button")
	.on("click", function(d) {

		// Deselect all of the other buttons
		d3.select(".selected")
			.classed("selected", false);

		// Select the clicked button
		d3.select(this)
			.classed("selected", true);

		// Update the display year
        display_year = d3.select(this).text();

		// Update the visualsiation
		generateVis();
		
		// If the user selectes a specifc year then stop loopping if it is in action
		clearInterval(playInterval);
	});


	// A global variable for the interval listeneer so that it can be stopped elsewhere
	var playInterval;	
	    

	// Add an event listener to the play all button do that when it is clicked the visualisaiton iterates through the different years
	
		
            d3.select("stop_button")
		.on("click", function() {
                		clearInterval(playInterval);
            })

            
                        
var slider = document.getElementById("myRange");
var output = document.getElementById("demo");
output.innerHTML = slider.value; // Display the default slider value

// Update the current slider value (each time you drag the slider handle)
slider.oninput = function() {
    output.innerHTML = this.value;
    console.log(output.innerHTML);
    // Update the display year
        display_year = output.innerHTML;
		generateVis();
    
    
}
d3.select(".play")
		.on("click", function() {

			// Set up the interval callback
			playInterval = setInterval(function() {
			 
			// Increment the display year
			display_year++;
						
			// Make the display_year loop around from max to min
			if(display_year > 2017){
				display_year = 2007;
			}
			
			// Update the visualsiation
			generateVis();
                slider++;
		output.innerHTML++;

			}, 1000);
		});	
            
            d3.select("#play").on("click", function() {
                clearInterval(playInterval);
                playInterval=setInterval(function() {
                    	var b= d3.select(slider);
       
                        var t = (+b.property("value") + 1) % (+b.property("max") + 1);
                    console.log(t);
                        if (t == 0) { t = +b.property("min"); }
                        b.property("value", t);
                    display_year=t;
                    
                    generateVis();
                     output.innerHTML = t;
                      
    }, 1000);
                });

            d3.select("#pause").on("click", function() {
	clearInterval (playInterval);
});

			// Set the domains of the x and y scales using the data
			var max_close = d3.max(dataset, function(d) { return d.Global_Competitiveness_Index;} );
			var max_date = d3.max(dataset, function(d) { return d.GDP;} );
			var min_date = d3.min(dataset, function(d) { return d.GDP;} );
		
			xScale.domain([min_date, max_date]);
			yScale.domain([0, max_close]);
            rScale.domain([0, d3.max(dataset, function(d) { return +d.Population;}) ])
            


			// Create the x-axis
			svg.append("g")
				.attr("class", "axis")
				.attr("id", "x-axis")
				.attr("transform", "translate(0," + svg_height + ")")
				.call(xAxis)
            	.append("text")
				      .attr("y", 50)
                      .attr("x", 330)
                    .style("font-size", "15px")
                        .attr("font-family", "sans-serif")
                      .attr("fill", "black") 
				      .style("text-anchor", "end")
				      .text("GDP");
				
			// Create the y axis
			svg.append("g")
				.attr("class", "axis")
				.attr("id", "y-axis")
				.call(yAxis)
            
				.append("text")
				      .attr("transform", "rotate(-90)")
            
            .attr("fill", "black") 
            .style("font-size", "15px")
				      .attr("y", -60)
                        .attr("x", -130)
				      .attr("dy", ".71em")
				      .style("text-anchor", "end")
				      .text("Global Competitive Index");
            
     //       generateVis();

				
        	// Generate the visualisation
//			setInterval(function() {
//			display_year = display_year + 1;
//			if(display_year > 2017){
//				display_year = 2007;
//			}
//		  	generateVis();
//		}, 2000);	
	}

 

	
		
	});
		</script>
		</div>

	
	</div>
</body>	 
</html>